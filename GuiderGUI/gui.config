#!/bin/bash

# Config file for DS9 bash scripts which run the ACAM and slice-viewer GUIs
# Additional settings are in 
#   /home/developer/Software/Config/acamd.cfg.in

camera=$1  # guider or slicev
camera_lc=$(printf '%s' "$camera" | tr '[:upper:]' '[:lower:]')

guipath=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )  # Directory of this file

# Provide sane defaults if env vars are missing (DS9 can drop shell env)
if [ -z "$NGPS_ROOT" ]; then
	NGPS_ROOT=$(cd "$guipath/.." && pwd)
fi
data_root="${NGPS_DATA_DIR:-$NGPS_ROOT/data}"
# If NGPS_DATA_DIR already points to a datedir, keep it. Otherwise, pick latest datedir.
base_name=$(basename "$data_root")
if [[ "$base_name" =~ ^[0-9]{8}$ ]] && [ -d "$data_root" ]; then
	NGPS_DATA_DIR="$data_root"
else
	latest=""
	for d in "$data_root"/[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]; do
		[ -d "$d" ] || continue
		b=$(basename "$d")
		if [ -z "$latest" ] || [ "$b" -gt "$latest" ]; then
			latest="$b"
		fi
	done
	if [ -z "$latest" ]; then
		latest="$(date +%Y%m%d)"
	fi
	NGPS_DATA_DIR="$data_root/$latest"
fi

if [ "$camera_lc" = 'guider' ]; then

	id=GUIDER										# Unique ds9 window name
  	demon=acam                  # demon command
	startfile=$guipath/graphics/NGPSsplash_guider.png		# PNG image to display at startup
	ansfile=$guipath/buttons_guider.ans 			# ds9 analysis/buttons file with updated parameters 
	anstemplate=$guipath/template_guider.ans 		# ds9 analysis/buttons template
	cmap=cool 										# color map
	geometry=625x850 								# window dimensions
	fitstype=fits 									# how to interpret FITS file
	grabdir=${NGPS_DATA_DIR:-$NGPS_ROOT/data}/acam  # directory where "grab fits" saves
	synccommand="acam guideset" 					# daemon command to push settings to this GUI
	headsup_fontsize=12 							# font size for displayed camera settings
	headsup_fontcolor=yellow 						# font color for displayed camera settings
	headsup_font=helvetica							# font name
	headsup_fontstyle=bold							# font style

elif [ "$camera_lc" = 'slicev' ]; then

	id=SLICEVIEW									# Unique ds9 window name
 	demon=scam                    # demon command
	startfile=$guipath/graphics/NGPSsplash_slicev.png		# PNG image to display at startup
	ansfile=$guipath/buttons_slicev.ans				# ds9 analysis/buttons file with updated parameters 
	anstemplate=$guipath/template_slicev.ans		# ds9 analysis/buttons template
	cmap=magma										# color map
	geometry=625x850								# window dimensions
	fitstype="mosaicimage wcs"						# how to interpret FITS file
	grabdir=${NGPS_DATA_DIR:-$NGPS_ROOT/data}/slicecam  # directory where "grab fits" saves
	synccommand="scam guiset"						# daemon command to push settings to this GUI
	headsup_fontsize=13								# font size for displayed camera settings
	headsup_fontcolor=yellow						# font color for displayed camera settings
	headsup_font=helvetica							# font name
	headsup_fontstyle=bold							# font style
	jogfile=/tmp/jog.ini 						# file containing the current scam jog setting
	graphic_color=cyan								# color of graphic regions (slit, TCS)

else echo "Invalid camera name.  Must be guider or slicev"

fi
